name: Add Approvers to Environments

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        type: choice
        options: ['dev', 'pre', 'pro']
        default: 'dev'
      approver:
        description: 'Username of the approver'
        required: true
        default: 'approver_username'

jobs:
  add-approvers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3


      - name: Get team ID
        id: get_team_id
        env:
          ORGANIZATION: ${{ vars.ORGANIZATION }}
          ENVIRONMENT: ${{ inputs.environment }}
          APPROVER: ${{ inputs.approver }}
        run: |
          TEAM_ID=$(curl -H "Authorization: token ${{ secrets.GH_PAT }}" https://api.github.com/orgs/$ORGANIZATION/teams/$APPROVER | jq -r ".id")
          echo "TEAM_ID=$TEAM_ID" >> $GITHUB_OUTPUT

      - name: Add Approvers to Environments
        env:
          ORGANIZATION: ${{ vars.ORGANIZATION }}
          ENVIRONMENT: ${{ inputs.environment }}
          APPROVER: ${{ inputs.approver }}
        run: |
          cat repos.txt
          echo TEAM_ID ${{ steps.get_team_id.outputs.TEAM_ID }}
          while read -r line;
          do

            ENV_ID=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
              "https://api.github.com/repos/$ORGANIZATION/$line/environments" | jq -r ".environments[] | select(.name==\"$ENVIRONMENT\") | .id")

            echo ENV_ID: $ENV_ID

            if [ -z "$ENV_ID" ]; then
              echo "Environment $ENVIRONMENT not found in repository $line"
              continue
            fi

            # JSON_PAYLOAD=$(cat <<EOF
            # {
            #   "wait_timer": 30,
            #   "prevent_self_review": false,
            #   "reviewers": [
            #     {
            #       "type": "Team",
            #       "id": $TEAM_ID
            #     }
            #   ],
            #   "deployment_branch_policy": {
            #     "protected_branches": false,
            #     "custom_branch_policies": true
            #   }
            # }
            # EOF
            # )

            curl -L \
              -X PUT \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/$ORGANIZATION/$line/environments/$ENVIRONMENT \
              -d '{"prevent_self_review":false,"reviewers":[{"type":"Team","id":${{ steps.get_team_id.outputs.TEAM_ID }}}],"deployment_branch_policy":{"protected_branches":false,"custom_branch_policies":false}}'

            echo "Approver $APPROVER added to environment $ENVIRONMENT in repository $line"

          done < repos.txt
